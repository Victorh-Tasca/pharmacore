<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="documentação-do-projeto-farmácia">Documentação do Projeto —
Farmácia</h1>
<p>Este documento apresenta o levantamento de requisitos, regras de
negócio, fluxos operacionais e visão geral das validações do sistema de
gestão de estoque de medicamentos, com base no schema PostgreSQL em
<code>schema_farmacia.sql</code>.</p>
<h2 id="objetivo">Objetivo</h2>
<ul>
<li>Controlar entradas e saídas de medicamentos por lote (validade), com
estoque calculado automaticamente.</li>
<li>Emitir alertas operacionais (validade, reposição mínima, mês de
vencimento iniciado).</li>
<li>Garantir rastreabilidade (fornecedor, lote do fabricante, paciente,
responsável).</li>
<li>Assegurar controle de acesso por usuários, papéis e permissões.</li>
</ul>
<h2 id="requisitos-funcionais">Requisitos Funcionais</h2>
<ul>
<li>Cadastro de medicamentos com: nome padronizado (princípio ativo +
dosagem + apresentação), classe terapêutica, tarja, forma de retirada
(MIP/prescrição), forma física, apresentação, unidade base,
genérico/original, limite mínimo, laboratório e código único do
remédio.</li>
<li>Gestão de lotes por validade (agrupamento mensal), com data de
fabricação e validade obrigatórias.</li>
<li>Entradas: fornecedor obrigatório, data de entrada, número do lote do
fabricante, quantidade informada e conversão para unidade base
(caixa/frascos → comprimidos/ml).</li>
<li>Dispensações: paciente identificado (CPF), data da dispensação,
responsável (opcional), quantidade informada e conversão para base,
bloqueio de lote vencido e de saída acima do saldo.</li>
<li>Estoque calculado automaticamente (soma das entradas em base – soma
das saídas em base).</li>
<li>Alertas: validade (≤30 dias e vencido), início do mês de vencimento,
reposição mínima, &lt;10 unidades, ≤20% do estoque inicial (entradas
cumuladas).</li>
<li>Controle de acesso: permissões por papel e por usuário, checagem
considerando usuário ativo.</li>
</ul>
<h2 id="regras-de-negócio-resumo">Regras de Negócio (Resumo)</h2>
<ul>
<li>Lote é determinado pela validade mensal: um lote por
medicamento/validade_mês (UNIQUE).</li>
<li>Nenhuma movimentação sem lote com validade.</li>
<li>Bloqueio de dispensação de lotes vencidos.</li>
<li>Dispensação só ocorre se houver saldo suficiente.</li>
<li>Receita obrigatória quando forma de retirada for “com
prescrição”.</li>
<li>Código do medicamento é único, informado manualmente.</li>
<li>Serial por classe terapêutica gerado automaticamente no cadastro do
medicamento.</li>
<li>Estoque baixo quando saldo ≤ limite mínimo, ou saldo &lt; 10, ou
saldo ≤ 20% das entradas.</li>
<li>Paciente deve ter CPF válido (constraint) e pode ter telefone e
cidade.</li>
<li>Senha de usuário armazenada em hash (bcrypt via pgcrypto).</li>
</ul>
<h2 id="fluxos-operacionais">Fluxos Operacionais</h2>
<ul>
<li>Entrada:
<ul>
<li>Registrar fornecedor, lote (válido), número do lote do fabricante,
unidade e quantidade informada.</li>
<li>Se a unidade informada não for a unidade base do medicamento,
informar <code>unidades_por_embalagem</code> para conversão a
<code>quantidade_base</code> (trigger calcula).</li>
</ul></li>
<li>Saída:
<ul>
<li>Selecionar paciente (CPF válido), lote, unidade e quantidade
informada.</li>
<li>Sistema converte para <code>quantidade_base</code> e verifica saldo
e validade (trigger bloqueia se vencido/insuficiente).</li>
<li>Se medicamento exigir prescrição, informar
<code>numero_receita</code>.</li>
</ul></li>
<li>Alertas:
<ul>
<li>Validade (≤30 dias ou vencido) via
<code>vw_alerta_validade</code>.</li>
<li>Início do mês de vencimento via
<code>vw_alerta_validade_mes_atual</code>.</li>
<li>Estoque baixo via <code>vw_alerta_estoque_baixo</code>.</li>
</ul></li>
<li>Arquivamento:
<ul>
<li>Funções desativam lote/medicamento quando sem saldo ou vencido
(preserva histórico).</li>
</ul></li>
</ul>
<h2 id="controle-de-acesso-rbac">Controle de Acesso (RBAC)</h2>
<ul>
<li>Usuários (ativos/inativos) com login e email únicos; senha
hash.</li>
<li>Papéis agregam permissões (ex.: admin, estoquista, atendente,
analista).</li>
<li>Permissões básicas: <code>acesso_sistema</code>,
<code>relatorios</code>, <code>entradas</code>, <code>saidas</code>,
<code>estoque</code>.</li>
<li>View <code>vw_usuarios_permissoes_efetivas</code> consolida
permissões diretas + via papel.</li>
<li>Função <code>fn_usuario_tem_permissao(usuario_id, codigo)</code>
retorna TRUE somente para usuário ativo com a permissão.</li>
</ul>
<h2 id="views-e-funções-principais">Views e Funções Principais</h2>
<ul>
<li>Views:
<ul>
<li><code>vw_estoque_por_lote</code>: saldo, dias para vencimento e
status (OK/Próximo de vencer/Bloquear dispensação).</li>
<li><code>vw_estoque_por_medicamento</code>: saldo consolidado e alertas
de reposição.</li>
<li><code>vw_alerta_validade</code>: próximos de vencer e vencidos.</li>
<li><code>vw_alerta_validade_mes_atual</code>: lotes cujo mês de
vencimento é o mês corrente.</li>
<li><code>vw_alerta_estoque_baixo</code>: consolida condições de estoque
baixo.</li>
<li><code>vw_usuarios_permissoes_efetivas</code>: permissões do
usuário.</li>
</ul></li>
<li>Funções e Triggers:
<ul>
<li><code>fn_set_serial_por_classe</code> +
<code>trg_set_serial_por_classe</code>: serial sequencial por classe
para medicamentos.</li>
<li><code>fn_calc_quantidade_base_entrada</code> +
<code>trg_calc_quantidade_base_entrada</code>: conversão de entrada para
unidade base.</li>
<li><code>fn_calc_quantidade_base_dispensacao</code> +
<code>trg_calc_quantidade_base_dispensacao</code>: conversão de saída
para base.</li>
<li><code>fn_check_saldo_e_validade_dispensacao</code> +
<code>trg_check_saldo_e_validade_dispensacao</code>: bloqueios de
vencimento e saldo; receita obrigatória.</li>
<li><code>fn_arquivar_lote_se_sem_saldo_ou_vencido</code> e
<code>fn_arquivar_medicamento_se_sem_saldo</code>: exclusão lógica.</li>
<li><code>fn_usuario_tem_permissao</code>: checagem de permissão.</li>
<li><code>fn_cpf_valido</code> + <code>CHECK</code> em
<code>pacientes.cpf</code>: validação de CPF.</li>
</ul></li>
</ul>
<h2 id="execução">Execução</h2>
<ul>
<li>Execute <code>schema_farmacia.sql</code> no PostgreSQL (ex.:
<code>psql -f schema_farmacia.sql</code>).</li>
<li>Cadastre classes terapêuticas com <code>codigo_classe</code>,
laboratórios e fornecedores.</li>
<li>Cadastre medicamentos (serial da classe é gerado
automaticamente).</li>
<li>Lance lotes (com data de fabricação/validade) e entradas.</li>
<li>Cadastre pacientes e faça dispensações.</li>
<li>Configure usuários, papéis e permissões (seeds de permissões já
incluídos).</li>
</ul>
<h2 id="dicionário-de-dados">Dicionário de Dados</h2>
<ul>
<li>Consulte <code>docs/dicionario_de_dados.md</code> para detalhes de
campos, tipos, FKs, unicidades e validações de cada tabela, view e
função.</li>
</ul>
</body>
</html>
